name: CI/CD Pipeline with Podman

# =============================================================================
# Triggers: Run on push and pull requests to main branch
# =============================================================================
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# =============================================================================
# Environment variables
# =============================================================================
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

# =============================================================================
# Jobs
# =============================================================================
jobs:
  # ---------------------------------------------------------------------------
  # Job 1: Build and Push Container Image
  # ---------------------------------------------------------------------------
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # Required for pushing to GHCR

    steps:
      # -----------------------------------------------------------------------
      # Step 1: Checkout repository
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Step 2: Setup Node.js with caching for faster installs
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm' # Cache npm dependencies (saves 30-60s)

      # -----------------------------------------------------------------------
      # Step 3: Install dependencies
      # -----------------------------------------------------------------------
      - name: Install dependencies
        run: npm ci

      # -----------------------------------------------------------------------
      # Step 4: Generate Prisma Client
      # -----------------------------------------------------------------------
      - name: Generate Prisma Client
        run: npx prisma generate

      # -----------------------------------------------------------------------
      # Step 5: Build NestJS application
      # -----------------------------------------------------------------------
      - name: Build application
        run: npm run build

      # -----------------------------------------------------------------------
      # Step 6: Setup Podman
      # -----------------------------------------------------------------------
      - name: Setup Podman
        run: |
          sudo apt-get update
          sudo apt-get -y install podman
          podman --version

      # -----------------------------------------------------------------------
      # Step 7: Log in to GitHub Container Registry
      # Uses GITHUB_TOKEN (automatically provided by GitHub Actions)
      # -----------------------------------------------------------------------
      - name: Log in to GitHub Container Registry
        uses: redhat-actions/podman-login@v1
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------------------
      # Step 8: Extract metadata for Docker/Podman
      # Generates tags and labels for the container image
      # -----------------------------------------------------------------------
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Tag with 'latest' for main branch
            type=raw,value=latest,enable={{is_default_branch}}
            # Tag with commit SHA (short form)
            type=sha,prefix={{branch}}-,format=short
            # Tag with branch name
            type=ref,event=branch
            # Tag with PR number
            type=ref,event=pr

      # -----------------------------------------------------------------------
      # Step 9: Build container image with Podman
      # Uses Containerfile for multi-stage build
      # -----------------------------------------------------------------------
      - name: Build container image
        id: build
        run: |
          podman build \
            --file Containerfile \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --label "org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            --label "org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            .

          echo "Build completed successfully"
          podman images | grep portfolio-api

      # -----------------------------------------------------------------------
      # Step 10: Push image to GitHub Container Registry
      # Only push on main branch (skip for PRs)
      # -----------------------------------------------------------------------
      - name: Push image to registry
        if: github.event_name != 'pull_request'
        run: |
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          echo "Images pushed successfully to ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"

      # -----------------------------------------------------------------------
      # Step 11: Display image information
      # -----------------------------------------------------------------------
      - name: Display image info
        run: |
          echo "==================================="
          echo "Container Image Built Successfully"
          echo "==================================="
          echo "Registry: ${{ env.REGISTRY }}"
          echo "Image: ${{ env.IMAGE_NAME }}"
          echo "Tags:"
          echo "  - latest"
          echo "  - ${{ github.sha }}"
          echo ""
          echo "Pull command:"
          echo "  podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "Image details:"
          podman inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest --format '{{.Size}}' | numfmt --to=iec-i --suffix=B

  # ---------------------------------------------------------------------------
  # Job 2: Deploy to Remote Server via Cloudflare Tunnel
  # ---------------------------------------------------------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    # Only deploy on push to main (not on PRs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      # -----------------------------------------------------------------------
      # Step 1: Install Cloudflare Tunnel (cloudflared)
      # -----------------------------------------------------------------------
      - name: Install Cloudflare Tunnel
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          cloudflared --version

      # -----------------------------------------------------------------------
      # Step 2: Setup SSH key from GitHub Secrets
      # -----------------------------------------------------------------------
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Disable strict host key checking for Cloudflare Tunnel
          cat >> ~/.ssh/config <<EOF
          Host ssh.rizaru-desu.my.id
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ProxyCommand cloudflared access ssh --hostname ssh.rizaru-desu.my.id
            Port 7022
            User root
          EOF
          chmod 600 ~/.ssh/config

      # -----------------------------------------------------------------------
      # Step 3: Test SSH connection
      # -----------------------------------------------------------------------
      - name: Test SSH connection
        run: |
          ssh ssh.rizaru-desu.my.id "echo 'SSH connection successful via Cloudflare Tunnel'"

      # -----------------------------------------------------------------------
      # Step 4: Deploy to remote server
      # -----------------------------------------------------------------------
      - name: Deploy to remote server
        env:
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Application environment variables from secrets
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
        run: |
          ssh ssh.rizaru-desu.my.id bash -s <<'ENDSSH'
            set -e
            
            echo "================================================"
            echo "Starting deployment of portfolio-api"
            echo "================================================"
            
            # Login to GitHub Container Registry
            echo "Logging in to GHCR..."
            echo "${{ secrets.GITHUB_TOKEN }}" | podman login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Pull latest image
            echo "Pulling latest image..."
            podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            
            # Stop and remove old container (if exists)
            echo "Stopping old container..."
            podman stop portfolio-api 2>/dev/null || true
            podman rm portfolio-api 2>/dev/null || true
            
            # Run new container with environment variables
            echo "Starting new container..."
            podman run -d \
              --name portfolio-api \
              --publish 3000:3000 \
              --restart=always \
              --env NODE_ENV=production \
              --env DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              --env REDIS_URL="${{ secrets.REDIS_URL }}" \
              --env JWT_SECRET="${{ secrets.JWT_SECRET }}" \
              --env SMTP_HOST="${{ secrets.SMTP_HOST }}" \
              --env SMTP_PORT="${{ secrets.SMTP_PORT }}" \
              --env SMTP_USER="${{ secrets.SMTP_USER }}" \
              --env SMTP_PASSWORD="${{ secrets.SMTP_PASSWORD }}" \
              --env SMTP_FROM="${{ secrets.SMTP_FROM }}" \
              --health-cmd="curl -f http://localhost:3000 || exit 1" \
              --health-interval=30s \
              --health-timeout=3s \
              --health-retries=3 \
              ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            
            # Wait for container to be healthy
            echo "Waiting for container to be healthy..."
            sleep 5
            
            # Check container status
            echo "Container status:"
            podman ps | grep portfolio-api
            
            # Verify application is responding
            echo "Testing application endpoint..."
            sleep 3
            curl -f http://localhost:3000 || echo "Warning: Health check failed, but container is running"
            
            # Cleanup old images (keep latest 3)
            echo "Cleaning up old images..."
            podman image prune -af --filter "until=72h" || true
            
            echo "================================================"
            echo "Deployment completed successfully!"
            echo "================================================"
            echo "Container: portfolio-api"
            echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
            echo "Status: $(podman inspect portfolio-api --format '{{.State.Status}}')"
            echo "================================================"
          ENDSSH

      # -----------------------------------------------------------------------
      # Step 5: Deployment summary
      # -----------------------------------------------------------------------
      - name: Deployment summary
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ðŸ“¦ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo "ðŸš€ Server: ssh.rizaru-desu.my.id"
          echo "ðŸ”— Container: portfolio-api"
          echo "ðŸ“Š Check logs: ssh ssh.rizaru-desu.my.id podman logs -f portfolio-api"
